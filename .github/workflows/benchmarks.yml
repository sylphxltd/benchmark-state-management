name: Benchmark Suite

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger
  push:
    paths:
      - 'benchmarks/**'
      - 'scripts/**'
      - '.github/workflows/benchmarks.yml'

jobs:
  # ============================================================================
  # Check all categories for updates in parallel
  # ============================================================================
  check-updates:
    name: Check ${{ matrix.category }} for Updates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category: [state-management, immutability, router, css-frameworks]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install root dependencies
        run: npm ci

      - name: Install ${{ matrix.category }} dependencies
        working-directory: benchmarks/${{ matrix.category }}
        run: npm ci

      - name: Check for version updates
        id: check
        working-directory: benchmarks/${{ matrix.category }}
        run: |
          npx tsx ../../scripts/check-versions.ts .
        continue-on-error: true

      - name: Save check results
        if: always()
        run: |
          # Create a status file for the plan job to read
          mkdir -p /tmp/check-results
          echo "${{ steps.check.outputs.has_updates }}" > /tmp/check-results/${{ matrix.category }}.txt
          echo "${{ steps.check.outputs.updated_libs }}" > /tmp/check-results/${{ matrix.category }}-libs.json

      - name: Upload check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: check-result-${{ matrix.category }}
          path: /tmp/check-results/
          retention-days: 1

      - name: Upload versions file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: versions-${{ matrix.category }}
          path: benchmarks/${{ matrix.category }}/versions.json
          retention-days: 1

  # ============================================================================
  # Determine what needs to run
  # ============================================================================
  plan:
    name: Plan Benchmark Execution
    needs: check-updates
    runs-on: ubuntu-latest
    outputs:
      state-management: ${{ steps.determine.outputs.state-management }}
      immutability: ${{ steps.determine.outputs.immutability }}
      router: ${{ steps.determine.outputs.router }}
      css-frameworks: ${{ steps.determine.outputs.css-frameworks }}
      any-updates: ${{ steps.determine.outputs.any-updates }}

    steps:
      - name: Download check results
        uses: actions/download-artifact@v4
        with:
          pattern: check-result-*
          path: /tmp/check-results
          merge-multiple: true

      - name: Determine what to run
        id: determine
        run: |
          STATE_MGMT="false"
          IMMUTABILITY="false"
          ROUTER="false"
          CSS_FRAMEWORKS="false"

          # If manual trigger, run all
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            STATE_MGMT="true"
            IMMUTABILITY="true"
            ROUTER="true"
            CSS_FRAMEWORKS="true"
            echo "ðŸ“ Manual trigger - running all categories"
          else
            # Check each category's status file
            if [ -f "/tmp/check-results/state-management.txt" ]; then
              STATUS=$(cat /tmp/check-results/state-management.txt)
              if [ "$STATUS" == "true" ]; then
                STATE_MGMT="true"
                echo "âœ… State Management has updates"
              else
                echo "â­ï¸  State Management - no updates"
              fi
            fi

            if [ -f "/tmp/check-results/immutability.txt" ]; then
              STATUS=$(cat /tmp/check-results/immutability.txt)
              if [ "$STATUS" == "true" ]; then
                IMMUTABILITY="true"
                echo "âœ… Immutability has updates"
              else
                echo "â­ï¸  Immutability - no updates"
              fi
            fi

            if [ -f "/tmp/check-results/router.txt" ]; then
              STATUS=$(cat /tmp/check-results/router.txt)
              if [ "$STATUS" == "true" ]; then
                ROUTER="true"
                echo "âœ… Router has updates"
              else
                echo "â­ï¸  Router - no updates"
              fi
            fi

            if [ -f "/tmp/check-results/css-frameworks.txt" ]; then
              STATUS=$(cat /tmp/check-results/css-frameworks.txt)
              if [ "$STATUS" == "true" ]; then
                CSS_FRAMEWORKS="true"
                echo "âœ… CSS Frameworks has updates"
              else
                echo "â­ï¸  CSS Frameworks - no updates"
              fi
            fi
          fi

          echo "state-management=$STATE_MGMT" >> $GITHUB_OUTPUT
          echo "immutability=$IMMUTABILITY" >> $GITHUB_OUTPUT
          echo "router=$ROUTER" >> $GITHUB_OUTPUT
          echo "css-frameworks=$CSS_FRAMEWORKS" >> $GITHUB_OUTPUT

          # Set any-updates if any category needs updates
          if [ "$STATE_MGMT" == "true" ] || [ "$IMMUTABILITY" == "true" ] || [ "$ROUTER" == "true" ] || [ "$CSS_FRAMEWORKS" == "true" ]; then
            echo "any-updates=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“Š Summary: Updates detected, benchmarks will run"
          else
            echo "any-updates=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ¨ No updates detected, benchmarks will be skipped"
          fi

  # ============================================================================
  # Run benchmarks for each category
  # ============================================================================
  benchmark-state-management:
    name: Benchmark State Management
    needs: [check-updates, plan]
    if: needs.plan.outputs.state-management == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download versions file
        uses: actions/download-artifact@v4
        with:
          name: versions-state-management
          path: benchmarks/state-management/

      - name: Install root dependencies
        run: npm ci

      - name: Update packages incrementally
        id: update
        run: npx tsx scripts/update-single-package.ts benchmarks/state-management

      - name: Run benchmarks
        working-directory: benchmarks/state-management
        run: npm run benchmark
        # Note: Always run benchmarks if this job runs, since we're here because
        # check-updates detected changes (either package updates or test file changes)

      - name: Generate trend charts
        run: node scripts/generate-trend-charts.cjs benchmarks/state-management || echo "Not enough historical data for charts"

      - name: Generate README
        run: npx tsx scripts/generate-readme.ts benchmarks/state-management

      - name: Update versions.json with benchmark timestamp
        working-directory: benchmarks/state-management
        run: |
          jq '.lastBenchmarkRun = (now | todate)' versions.json > versions.tmp.json
          mv versions.tmp.json versions.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: results-state-management
          path: benchmarks/state-management/
          retention-days: 7

  benchmark-immutability:
    name: Benchmark Immutability
    needs: [check-updates, plan]
    if: needs.plan.outputs.immutability == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download versions file
        uses: actions/download-artifact@v4
        with:
          name: versions-immutability
          path: benchmarks/immutability/

      - name: Install root dependencies
        run: npm ci

      - name: Update packages incrementally
        id: update
        run: npx tsx scripts/update-single-package.ts benchmarks/immutability

      - name: Run benchmarks
        working-directory: benchmarks/immutability
        run: npm run benchmark
        # Note: Always run benchmarks if this job runs, since we're here because
        # check-updates detected changes (either package updates or test file changes)

      - name: Generate trend charts
        run: node scripts/generate-trend-charts.cjs benchmarks/immutability || echo "Not enough historical data for charts"

      - name: Generate README
        run: npx tsx scripts/generate-readme.ts benchmarks/immutability

      - name: Update versions.json with benchmark timestamp
        working-directory: benchmarks/immutability
        run: |
          jq '.lastBenchmarkRun = (now | todate)' versions.json > versions.tmp.json
          mv versions.tmp.json versions.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: results-immutability
          path: benchmarks/immutability/
          retention-days: 7

  benchmark-router:
    name: Benchmark Router
    needs: [check-updates, plan]
    if: needs.plan.outputs.router == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download versions file
        uses: actions/download-artifact@v4
        with:
          name: versions-router
          path: benchmarks/router/

      - name: Install root dependencies
        run: npm ci

      - name: Update packages incrementally
        id: update
        run: npx tsx scripts/update-single-package.ts benchmarks/router

      - name: Run benchmarks
        working-directory: benchmarks/router
        run: npm run benchmark
        continue-on-error: true  # Router benchmarks are WIP
        # Note: Always run benchmarks if this job runs, since we're here because
        # check-updates detected changes (either package updates or test file changes)

      - name: Generate trend charts
        run: node scripts/generate-trend-charts.cjs benchmarks/router || echo "Not enough historical data for charts"
        continue-on-error: true  # Router benchmarks are WIP

      - name: Generate README
        run: npx tsx scripts/generate-readme.ts benchmarks/router
        continue-on-error: true  # Router benchmarks are WIP

      - name: Update versions.json with benchmark timestamp
        working-directory: benchmarks/router
        run: |
          jq '.lastBenchmarkRun = (now | todate)' versions.json > versions.tmp.json
          mv versions.tmp.json versions.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: results-router
          path: benchmarks/router/
          retention-days: 7

  benchmark-css-frameworks:
    name: Benchmark CSS Frameworks
    needs: [check-updates, plan]
    if: needs.plan.outputs.css-frameworks == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download versions file
        uses: actions/download-artifact@v4
        with:
          name: versions-css-frameworks
          path: benchmarks/css-frameworks/

      - name: Install root dependencies
        run: npm ci

      - name: Update packages incrementally
        id: update
        run: npx tsx scripts/update-single-package.ts benchmarks/css-frameworks

      - name: Run benchmarks
        working-directory: benchmarks/css-frameworks
        run: npm run benchmark
        # Note: Always run benchmarks if this job runs, since we're here because
        # check-updates detected changes (either package updates or test file changes)

      - name: Generate trend charts
        run: node scripts/generate-trend-charts.cjs benchmarks/css-frameworks || echo "Not enough historical data for charts"

      - name: Generate README
        run: npx tsx scripts/generate-readme.ts benchmarks/css-frameworks

      - name: Update versions.json with benchmark timestamp
        working-directory: benchmarks/css-frameworks
        run: |
          jq '.lastBenchmarkRun = (now | todate)' versions.json > versions.tmp.json
          mv versions.tmp.json versions.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: results-css-frameworks
          path: benchmarks/css-frameworks/
          retention-days: 7

  # ============================================================================
  # Commit all results
  # ============================================================================
  commit-results:
    name: Commit Results
    needs: [plan, benchmark-state-management, benchmark-immutability, benchmark-router, benchmark-css-frameworks]
    if: always() && needs.plan.outputs.any-updates == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install root dependencies
        run: npm ci

      - name: Download state-management results
        if: needs.plan.outputs.state-management == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: results-state-management
          path: benchmarks/state-management/

      - name: Download immutability results
        if: needs.plan.outputs.immutability == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: results-immutability
          path: benchmarks/immutability/

      - name: Download router results
        if: needs.plan.outputs.router == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: results-router
          path: benchmarks/router/

      - name: Download css-frameworks results
        if: needs.plan.outputs.css-frameworks == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: results-css-frameworks
          path: benchmarks/css-frameworks/

      - name: Generate root README
        run: npx tsx scripts/generate-root-readme.ts

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all benchmark results (including READMEs, results, versions.json, package files)
          git add benchmarks/ README.md

          # Create commit message
          COMMIT_MSG="chore: auto-update benchmark results"

          # List updated categories
          UPDATED_CATEGORIES=""
          if [ -f "benchmarks/state-management/README.md" ]; then
            UPDATED_CATEGORIES="$UPDATED_CATEGORIES\n- State Management"
          fi
          if [ -f "benchmarks/immutability/README.md" ]; then
            UPDATED_CATEGORIES="$UPDATED_CATEGORIES\n- Immutability"
          fi
          if [ -f "benchmarks/router/README.md" ]; then
            UPDATED_CATEGORIES="$UPDATED_CATEGORIES\n- Router"
          fi
          if [ -f "benchmarks/css-frameworks/README.md" ]; then
            UPDATED_CATEGORIES="$UPDATED_CATEGORIES\n- CSS Frameworks"
          fi

          if [ -n "$UPDATED_CATEGORIES" ]; then
            COMMIT_MSG="$COMMIT_MSG\n\nUpdated categories:$UPDATED_CATEGORIES"
          fi

          # Add package update information if available
          UPDATED_PACKAGES=""
          FAILED_PACKAGES=""

          # Check for updated packages in each category
          for category in state-management immutability router css-frameworks; do
            versions_file="benchmarks/$category/versions.json"
            if [ -f "$versions_file" ]; then
              # Extract packages that were recently updated (within last hour)
              recent_updates=$(jq -r --arg now "$(date -u +%Y-%m-%dT%H)" '.libraries | to_entries[] | select(.value.lastUpdated | startswith($now)) | "\(.key) â†’ \(.value.current)"' "$versions_file" 2>/dev/null || echo "")

              if [ -n "$recent_updates" ]; then
                if [ -z "$UPDATED_PACKAGES" ]; then
                  UPDATED_PACKAGES="\n\nPackage updates:"
                fi
                UPDATED_PACKAGES="$UPDATED_PACKAGES\n$category:"
                while IFS= read -r line; do
                  UPDATED_PACKAGES="$UPDATED_PACKAGES\n  - $line"
                done <<< "$recent_updates"
              fi

              # Extract incompatible packages
              incompatible=$(jq -r '.libraries | to_entries[] | select(.value.incompatible == true) | "  - \(.key) \(.value.incompatibleVersion): \(.value.incompatibleReason)"' "$versions_file" 2>/dev/null || echo "")

              if [ -n "$incompatible" ]; then
                if [ -z "$FAILED_PACKAGES" ]; then
                  FAILED_PACKAGES="\n\nIncompatible updates (rolled back):"
                fi
                FAILED_PACKAGES="$FAILED_PACKAGES\n$category:"
                echo "$incompatible" | while IFS= read -r line; do
                  FAILED_PACKAGES="$FAILED_PACKAGES\n$line"
                done
              fi
            fi
          done

          COMMIT_MSG="$COMMIT_MSG$UPDATED_PACKAGES$FAILED_PACKAGES"

          COMMIT_MSG="$COMMIT_MSG\n\n- Validated each package update with lightweight smoke tests\n- Ran full benchmarks once after all updates\n- Rolled back incompatible updates automatically\n- Generated category READMEs with latest results\n- Updated root README with library counts"

          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          git push || echo "Nothing to push"

  # ============================================================================
  # Skip notification
  # ============================================================================
  skip-benchmarks:
    name: No Updates Detected
    needs: [check-updates, plan]
    if: needs.plan.outputs.any-updates != 'true' && github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Report status
        run: |
          echo "âœ¨ No updates detected across all categories"
          echo "   - All libraries are up to date"
          echo "   - Test files unchanged"
          echo "   - Benchmarks skipped"
